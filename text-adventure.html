<body>

<div style="width:470px;align-content:center;">
<div style="height:14px;color:black;padding:2%;font-family:'Courier New', monospace;text-align:center;background-color:#ffff99">WHAT IS YOUR NAME?</div>
<span style="padding:4.7px;color:white;background-color:black;font-family:'Courier New', monospace;"><b>></b></span><input type="text" onkeypress="enterName(event,this)" style="width:441px;color:white;background-color:black;border:black solid 0pt;outline:none;font-size:12pt;padding:1%;font-family:'Courier New', monospace;">
<div id="whereabout" style="height:14px;color:black;padding:2%;font-family:'Courier New', monospace;text-align:center;background-color:#ffff99"></div>
<div id="platform" style="overflow:hidden;height:267.2px;color:white;background-color:black;font-family:'Courier New', monospace;text-align:justify;padding:2%"></div>
</div>

<div style="width:470px;align-content:center">
<span style="padding:4.9px;color:white;background-color:black;font-family:'Courier New', monospace;"><b>></b></span><input type="text" onkeypress="command(event,this)" style="width:441px;color:white;background-color:black;border:black solid 0pt;outline:none;font-size:12pt;padding:1%;font-family:'Courier New', monospace;">
</div>
</body>



<script>
var betaTesterName = "anonymous tester";
errorData = "https://script.google.com/macros/s/AKfycbzl8NsXkr6cZyqovRJ9KgUAL62ybxfnEYMUeuKgBVwJbcF4-qV68EnfTOY_iq6BQPrM/exec";
var xhr = new XMLHttpRequest();
pf = document.getElementById("platform");
inventory = ["hammer","lamp","dice", "raincoat"];
//quests = ["Find Lucy.","Bring shoes to Fisherman."];
//health = 15;

function getKeyByValue(object, value) {
  return Object.keys(object).find(key => object[key] === value);
}


//Necessary for bridge.
back = [0];
princeIsPresent = false;
alarmIsOn = false;

map = [
{whereabout:"IN A DARK ROOM", description:"You are in a dark room.", items:[], go:{yes:1, no:7, instructions:""}, fieldObject:[1], hint:"Type 'yes' to start the game or 'instructions' to read about your possibilities."},
{whereabout: "IN THE FOREST", description:"You are in a dim forest. Everywhere you look, you see these silent trees. It is very cold, so you might as well find some shelter for the night.", items:["raincoat","lamp"], go:{east:2}, fieldObject:[2], hint:"The wolf is not your friend, it's going to bite you. Scare it away somehow."},
{whereabout: "STILL IN THE FOREST", description:"You are still in the forest, but this path seems a little odd. You find strange footprints in the undergrowth. The creature that left them must be the size of a smaller bear. Well, smaller if you call it. I don't really know what kind of animal leaves such traces but I don't really want to find out.", items:["crown"], go:{west:1, east:3}, fieldObject:[3], block:3, hint:"If you want to cross the bridge, do what it takes."},
{whereabout: "IN THE MARSH OVER THE BRIDGE", description:"Over the bridge, a marsh spreads out to the east. This place reeks of corpses, you don't really want to stay here for long.", items:["lamp"], go:{west:2, north:4}, fieldObject:[3],  block:2, hint:"If you want to cross the bridge, do what it takes."},
{whereabout:"MOUNTAIN PATH",description:"North to the marsh, a mountain emerges from the desolate plate. It leads in an easterly direction to an abandoned building.",items:[],go:{south:3,east:5},fieldObject:[],hint:"Go toward the building, I guess."},
{whereabout:"MOUNTAIN PATH",description:"North to the marsh, a mountain emerges from the desolate plate. It leads in an easterly direction to an abandoned building.",items:[],go:{west:4,east:6},fieldObject:[],hint:"Go toward the building, I guess."},
{whereabout:"AT THE GATE OF THE ABANDONED MONASTERY",description:"After you clambered your way over the rocks, all slippery with the morning dew, you finally reached the building you spotted from the distance. The Monastery of Rahmat. The muddy footprints lead to a closed gate where the trail ends.",items:[],go:{west:5,east:7,south:19},fieldObject:[4], block:7, hint:"Find a way in."},
{whereabout:"IN THE GARDEN OF THE MONASTERY (N)",description:"You are in the garden of the abandoned monastery. Now that the monks are at a better place, nature reclaimed these mysterious ruins.",items:[],go:{west:6,east:8,south:12},fieldObject:[4,6], block:6, hint:"Western gate. Put 2 and 2 together.", princeIsPresent: function () {div = document.createElement("DIV"); div.innerHTML = "Prince James blocks your way to the west, so you can't go back to the forest.<br>PRINCE: Turn around, mate! We need to find a way to use the portal."; pf.appendChild(div); block(map[where].go,6)}},
{whereabout:"IN THE HALL OF THE MONASTERY",description:"-missing description-",items:[],go:{west:7,north:14,east:9,},fieldObject:[], hint:""},
{whereabout:"IN THE ATRIUM OF THE MONASTERY",description:"-missing description-",items:[],go:{west:8,north:16,east:15,south:10},fieldObject:[], hint:""},
{whereabout:"IN ST PAUL'S CHAPEL",description:"-missing description-",items:[],go:{north:9,east:23,},fieldObject:[], hint:""},
{whereabout:"IN THE LIBRARY",description:"-missing description-",items:[],go:{west:24,north:15,east:13,south:25},fieldObject:[], hint:""},
{whereabout:"IN THE GARDEN OF THE MONASTERY (S)",description:"You are in the garden of the abandoned monastery. Now that the monks are at a better place, nature reclaimed these mysterious ruins.",items:[],go:{north:7,east:20,south:19},fieldObject:[5], hint:""},
{whereabout:"IN THE LATE ABBOT'S ROOM",description:"-missing description-",items:[],go:{west:11,},fieldObject:[], hint:""},
{whereabout:"IN THE DORMITORY",description:"-missing description-",items:[],go:{north:8,east:24,},fieldObject:[], hint:""},
{whereabout:"IN THE REFECTORY",description:"-missing description-",items:[],go:{west:9,north:11,east:21,south:23},fieldObject:[], hint:""},
{whereabout:"IN THE BALNEARY",description:"-missing description-",items:[],go:{south:9},fieldObject:[], hint:""},
{whereabout:"IN THE KITCHEN",description:"-missing description-",items:[],go:{},fieldObject:[], hint:""},
{whereabout:"BY THE WELL",description:"-missing description-",items:[],go:{},fieldObject:[], hint:""},
{whereabout:"AT THE POSTERN",description:"It is your lucky day, you have found a side door into the monastery.",items:[],go:{west:6,north:12,},fieldObject:[8], hint:""},
{whereabout:"IN THE GARDEN OF THE MONASTERY (E)",description:"-missing description-",items:[],go:{west:12,north:21,},fieldObject:[9], hint:""},
{whereabout:"AT THE EASTERN GATE OF THE MONASTERY",description:"-missing description-",items:[],go:{west:15,east:22,south:20},fieldObject:[], block:22, hint:""},
{whereabout:"AT THE EASTERN GATE OF THE MONASTERY (OUTSIDE)",description:"-missing description-",items:[],go:{west:21,},fieldObject:["gate"], block:21, hint:""},
{whereabout:"IN THE VESTRY",description:"-missing description-",items:[],go:{west:10,north:15,},fieldObject:[], hint:""},
{whereabout:"ATRIUM (FIRST FLOOR)",description:"-missing description-",items:[],go:{west:14,north:26,east:11,},fieldObject:[], hint:""},
{whereabout:"TOWER",description:"-missing description-",items:[],go:{north:11,},fieldObject:[], hint:""},
{whereabout:"PORTAL ROOM",description:"-missing description-",items:[],go:{south:24},fieldObject:[], hint:""},
{whereabout:"JAIL",description:"-missing description-",items:[],go:{},fieldObject:[], hint:""},
];
//if fieldObject is undefined at go/directions and where and back

items = [
{article: "a", name:"raincoat", description: "An old raincoat. Nothing extraordinary.", use:true, combine:{"lamp": "luminous raincoat","water":"wet raincoat"}},
{article: "a", name:"crucifix", description: "An old, patinated crucifix. The form of its end reminds you of the letter F. Strange.", use:true,},
{article: "a", name:"wet raincoat", description: "Now you got it all wet. All applaud for the genious!", use:false, combine:{}},
{article: "a", name:"lamp", description: "A broken lamp. Still works, though.", use:true, combine:{"raincoat": "luminous raincoat"}},
{article: "a", name:"luminous raincoat", description: "It is not only a raincoat, it shines, too.", use:true, combine:{}},
{article: "some", name:"water", description: "I gotta be careful with this bottle of water. It is a key to my survival here.", use:true, combine:{"raincoat":"wet raincoat"}},
{article: "few", name:"matches", description: "Matches. You know what they do.", use:true, combine:{}},
{article: "a", name:"crown", description: "An antique crown. It must be worth a fortune.", use:true},{article: "a", name:"dice", description: "This is a classic dice. A bit worn, though.", use:true, combine:{}},
{article: "a", name:"sword", description: "The finest sword I've ever seen!", use:true, combine:{}},
{article: "a", name:"hammer", description: "A hammer with a head of the size of a toddler's. Useful when it comes to crashing things or breaking in somewhere.", use:true, combine:{}}
];

fieldObjects = [
{id: 1, name: "restless soul",
description: "In the darkest corner of the darkest room you've ever been sits a cruel-looking figure. He's the Restless Soul.",
"water": function() {pf.append("THE RESTLESS SOUL: I'm not thirsty.")},
"matches": function() {pf.append("THE RESTLESS SOUL: Thank you."); inventory.splice(inventory.indexOf("matches"),1)},
"dice": function() {hisNum = Math.floor((Math.random() * 6) + 1); yourNum = Math.floor((Math.random() * 6) + 1); pf.append("THE RESTLESS SOUL: You rolled " +  yourNum + " on the dice."); pf.append(" I rolled " + hisNum + "."); if (yourNum > hisNum) {result = document.createElement("DIV");
result.innerHTML = "<br>Look, you lucky, you won. I'll give you my sword if you give me your dice.";
pf.appendChild(result);
this.dice = function() {inventory.splice(inventory.indexOf("dice"),1); inventory.push("sword"); pf.append("THE RESTLESS SOUL: Magical! Here's my sword in return.")}

}},
type: "friend",
interact: {
"talk": function() {pf.append("THE RESTLESS SOUL: What the hell do you want?"); this["talk"] = function() {div = document.createElement("DIV"); div.innerHTML = "YOU: I want to know if there is balm in Gilead.<br>THE RESTLESS SOUL: Get the hell out of my sight."; pf.appendChild(div)};}
},
try: {"123": function() {pf.append("Nice try.")}},
ask: {"battle": function() {div = document.createElement("DIV"); div.innerHTML = "YOU: How did you get out of that mayhem, Your Highness?<br>PRINCE: I had a near escape, I tell you that!"; pf.appendChild(div)}, "war": function() {div = document.createElement("DIV"); div.innerHTML = "YOU: What are our chances with the war now, Your Highness?<br>PRINCE: No idea, mate."; pf.appendChild(div)}}
	},
{group: "wolf", id: 2, name: "left wolf",
description: "There's a wolf in here, snarling and growling at you.",
"lamp": function() {pf.append("The wolf got scared of the light and ran away."); map[where].fieldObject.splice(map[where].fieldObject.indexOf(this.id),1)},
type: "enemy",
interact: {
"pet": function() {pf.append("The ferocius wolf bit your hand as you were trying to pet it. It ain't your friend, so you'd better use something to scare it away."); this["pet"] = function() {pf.append("Are you a masochist?")};}
}
	},
{group: "wolf", id: 25, name: "right wolf",
description: "This is another wolf.",
"lamp": function() {pf.append("This wolf is not afraid of the light.");},
"water": function() {pf.append("It was made of ice. It was an icewolf. It melted.");map[where].fieldObject.splice(map[where].fieldObject.indexOf(this.id),1)},
type: "enemy",
interact: {
"pet": function() {pf.append("The ferocius wolf bit your hand as you were trying to pet it. It ain't your friend, so you'd better use something to scare it away."); this["pet"] = function() {pf.append("Are you a masochist?")};}
}
	},
{id: 3, name: "bridge",
description: "There's a wooden bridge here. You are too heavy, so you must get rid of everything you don't need.",
type: "obstacle",
interact: {}
	},
{id: 4, name: "gate",
description: "You are face to face with an enormous gate here. The Prince must have somehow found a way in.",
type: "obstacle",
//"hammer": function() {this.type = "friend"; this.description = "Somehow, the ruins of the gate remind you of human mortality."; reveal(map[where].go,map[where].block); pf.append("You broke the gate in.");},
hammer: function() {pf.append("Even with a warhammer like this, it seems impossible to break on through to the other side.")},
interact: {}
	},
{group: "monk", id: 5, name: "dead monk",
description: "A MONK sits by the wall. His head hangs down lifeless, his robe is drenched in blood. You check his pulse but there’s no helping him: he’s dead as a rock.",
type: "friend",
interact: {"search": function() {pf.append("You search through the robe of the dead monk and find a little CRUCIFIX."); inventory.push("crucifix")}}
	},
{group: "guard", id: 6, name: "shoron guard",
description: "A Shoron guard keeps watch over the gate, you better HIDE.",
type: "enemy",
interact: {"fight": function() {hisNum = Math.floor((Math.random() * 6) + 1); yourNum = Math.floor((Math.random() * 6) + 1); result = document.createElement("DIV"); if (yourNum >= hisNum) {result.innerHTML = "<br>You took your chances with the guard and won. The lifeless body of the guard lies in front of you.";
alert("your: " + yourNum + "his: " + hisNum)
pf.appendChild(result);
g = fieldObjects.find(element => element.id === 6);
g.name = "dead guard";
g.description = "The lifeless body of the Shoron guard lies at the gate.",
g.type = "friend",
g.interact = {
"search":function() {pf.append("You find nothing interesting on him.")}
	}
delete g.hide;
} else {
result.innerHTML = "<br>You took your chances with the guard and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in what seems like an hour in a dark cell.";
pf.appendChild(result);
inventory = [];
where = 27;
position();
}
}},
hide: function() {pf.append("You almost got caught but the guard didn't notice you. But it's still risky, you have to leave.")}
	},
{group:"door", id: 8, name: "side door",
description: "The door is nothing of interest. You get a feeling that it is unlocked.",
type: "friend",
interact: {"open":function() {pf.append("You open the door and carefully step through to the other side."); go("north")}}
	},
{group:"captain", id: 9, name: "shoron captain",
description: "A Shoron captain patrols through the garden. You'd better HIDE.",
type: "enemy",
interact: {"fight": function() {
result = document.createElement("DIV");
result.innerHTML = "<br>You took your chances with the guard and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in a dark cell.";
pf.appendChild(result);
inventory = []
where = 27;
position();
}},
hide: function() {
alert(map[where].fieldObject.indexOf(9));
map[where].fieldObject.splice(map[where].fieldObject.indexOf(9),1);
directions = Object.keys(map[where].go);
alert(directions)
alert(typeof Object.keys(map[where].go))
n = Math.floor(Math.random() * directions.length);
alert(n)
alert(directions[n])
map[map[where].go[directions[n]]].fieldObject.push(9);
alert(directions[n]);
pf.append("The captain doesn't notice you and walks away to the " + directions[n].toUpperCase() + ".");
}
	},
];



function checkItems(item) {
for (i=0; i<items.length; i++) {
if (items[i].name === item.toString()) {
return i;
}
}
}

function removeItem(arr, value) {
  var index = arr.indexOf(value);
  if (index > -1) {
    arr.splice(index, 1);
  }
  return arr;
}

function block(directions,block) {
asArray = Object.entries(directions).filter(([key, value]) => value === block);
directionsToBlockWithValues = Object.fromEntries(asArray);


Object.keys(directionsToBlockWithValues).forEach(function(key){ directionsToBlockWithValues[key] = null});
  
Object.assign(directions, directionsToBlockWithValues);
return directions;
}

function reveal(directions,block) {
asArray = Object.entries(directions).filter(([key, value]) => value === null);
directionsToBlockWithValues = Object.fromEntries(asArray);


Object.keys(directionsToBlockWithValues).forEach(function(key){ directionsToBlockWithValues[key] = block});
  
Object.assign(directions, directionsToBlockWithValues);
return directions;
}

library = {
"go":"This command has the same effect as calling the cardinal directions.",
"hint":"If you type 'hint' and press Enter, the Restless Soul gives you a hint about the place.",
"where":"This command recalls the description of the place you are currently at.",
"back":"This command enables you to go back to where you came from. NOTE: It's a one-way ticket.",
"get":"If you type GET LAMP and press Enter, you will GET the LAMP.",
"use":"This command lets you USE things. Also: DO. Not to be mistaken with COMBINE.",
"do":"This command lets you use things. Also: USE. Not to be mistaken with COMBINE.",
"combine":"This command enables you to COMBINE two things. For example, you can type COMBINE MATCHES AND TORCH, in which case you will get a FLAMING TORCH. Note that you can only COMBINE things that are in you inventory.",
"inventory":"Calling INVENTORY, you can check the items in your inventory. Also: INV, I"
};

instructions = document.createElement("DIV");
instructions.innerHTML = "This is a text adventure game.<br>To move, type west/north/east/south.<br>To examine an object, type its name.<br>To manipulate an object, type get/use/drop + its name.<br>To check your inventory, type inv.<br>Other possible commands are:<br>" + Object.keys(library).slice(0,4).toString().toUpperCase().replace(/,/g,", ") + " etc.<br>Call 'library' to read about them.<br>You are free to call this reminder ('instructions'), whenever you need it.";

dictionary = {
"west": "go west",
"east":"go east",
"north":"go north",
"south":"go south",
"inside":"go inside",
"outside":"go outside",
"out":"go out",
"in":"go in",
"yes":"go yes",
"no":"go no",
"up":"go up",
"down":"go down",
"forward":"go forward",
"x":"examine",
"look at":"examine",
"look":"examine",
"get rid of":"drop",
"dump":"drop",
"look around":"where",
"la":"where",
"help":"hint",
"w":"go west",
"e":"go east",
"n":"go north",
"s":"go south",
"talk to": "talk",
"speak":"talk",
"speak with":"talk",
"speak to":"talk",
}

dictionary1 = {
"spirit":"soul",
"restless soul":"restless soul",
"soul":"restless soul",
}

whereabout = document.getElementById("whereabout");
where = 7;
whereabout.innerText = map[where].whereabout.toUpperCase();
pf.append("THE RESTLESS SOUL: Do you wanna play, adventurer?");
options = document.createElement("DIV");
options.innerHTML = Object.keys(map[where].go).join("/");
options.style.textAlign = "center";
pf.append(options);

///////////// WHERE ////////////////
function position() {

whereabout.innerText = map[where].whereabout.toUpperCase();
pf.append(map[where].description);
if (map[where].items.length > 0) {
pf.append(" You also find ");
itemList = [];
for (z=0; z<map[where].items.length; z++) {
itemHere = items.find(element => element.name === map[where].items[z]);
itemList.push(itemHere.article + " " + itemHere.name);
}
itemList = itemList.toString();
lastComma = itemList.lastIndexOf(",");
if (lastComma > -1) {
itemList = itemList.slice(0,lastComma) + " and " + itemList.slice(lastComma+1,itemList.length);
pf.append(itemList.replace(/,/g,", ") + " on the ground.");
} else {
pf.append(itemList.replace(/,/g," and ") + " on the ground.");
}
}

for (t=0; t<map[where].fieldObject.length; t++) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[t]);
if (fo.description !== undefined && fo.description > "") {
pf.append(" " + fo.description);
}
}

if (princeIsPresent === true) {
map[where].princeIsPresent();
}

pf.append(" Possible directions are: " + Object.keys(map[where].go).filter(element => ["west","east","north","south","yes","no"].includes(element)).toString().toUpperCase().replace(/,/g, ", ") + ".");

}
/////////////////////////////////////////////////
function go(to) {

//if there is a dead shoron guard, alarm is called
if (fieldObjects.find(element => element.name === "dead guard") !== undefined && alarmIsOn === false) {
alarm = document.createElement("DIV");
alarm.innerHTML = "You are about to continue your stealth when you hear Shoron shouts behind your back. The fellow Shoron guards found out you're here and you killed one of theirs. You feel unsafe. 'Be careful,' you say to yourself.";
pf.appendChild(alarm);
alarmIsOn = true;
shoronAlarm();
} else if (alarmIsOn === true) {
shoronAlarm();
}

alert(JSON.stringify(map[where].go));
// ha ellenőrizni kell, hogy működnek az irányok
foType = [];

for (t=0; t<map[where].fieldObject.length; t++) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[t]);
foType.push(fo.type);
}


	if (foType.includes("obstacle")) {
alert("YES");
z = map[where].go;
t = map[where].block;
block(z,t);
alert(JSON.stringify(block(z,t)));

if (foType.includes("bridge") && inventory.length < 2) {
reveal(z,t);
alert(JSON.stringify(reveal(z,t)));
}
}
alert(JSON.stringify(map[where].go));

if (map[where].go[to] !== null) {
alert(where);
where = map[where].go[to];
position();
back.push(where);
} else if (princeIsPresent === true && where === 7) {
pf.append("You can't go there. The Prince doesn't let you through.");
} else {
pf.append("You can't go there. There's an obstacle in your way.");
}
alert(JSON.stringify(map[where].go));

}
//////////////////////////////
function examine(item) {


ids = fieldObjects.filter(element => element.name === item).map(function(obj) {return obj.id});
alert(ids)

id = map[where].fieldObject.filter(function(n) { return ids.indexOf(n) !== -1;});
alert(Number(id) > "")


if (Number(id) > "") {
alert(typeof id.toString())
pf.append(fieldObjects.find(element => element.id === Number(id)).description);
} else if (map[where].items.includes(item) || inventory.includes(item)) {
pf.append(items.find(element => element.name === item).description);
} else if (map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === item).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length > 1) {
pf.append("Which " + item + " do you mean?");
} else if (map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === item).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length === 1) {
id = map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === item).map(function(obj) {return obj.id}).indexOf(n) !== -1;});
pf.append(fieldObjects.find(element => element.id === Number(id)).description);

} else {
pf.append("Sorry, I can't see this: " + item.toUpperCase());
}
}
////////////////////////////////
function get(item) {

if (haveToHide === true) {
result = document.createElement("DIV");
result.innerHTML = "<br>You took your chances with the enemy and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in a dark cell.<br>";
pf.appendChild(result);
inventory = [];
where = 27;
position();

} else {

foType = [];

for (t=0; t<map[where].fieldObject.length; t++) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[t]);
foType.push(fo.type);
}

if (foType.includes("enemy") === false) {
if (inventory.length < 11) {
pf.append("You picked the " + item + ".");
inventory.push(item);
index = map[where].items.indexOf(item);
map[where].items.splice(index,1);
} else {
pf.append("Your 10-item inventory is full.");
}
} else {
pf.append("You can't do that. There's an enemy here.");
}

}
}
//////////////////////////////////
function use(item) {

isPossible = items.find(element => element.name === item).use;
if (inventory.includes(item) && isPossible == true) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[0]);
if (map[where].fieldObject.length === 1) {
if (map[where].fieldObject[0] && fo[item]) {
fo[item]();
} else {
pf.append("There's no point in doing that.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=use%20" + item + '&type=Not%20A%20Possible%20Usage&where=' + where);
/////////////////////////////////////////////////////////////////
}
} else {
pf.append("Use " + item.toUpperCase() + " on what?");
}
} else if (isPossible == false) {
pf.append("You can't USE that object.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=use%20" + item + '&type=Not%20Usable&where=' + where);
/////////////////////////////////////////////////////////////////
} else {
pf.append("Sorry, you're not carrying this: " + item.toUpperCase())
}
}
/////////////////////////////////////
function use2(item,fieldObj) {

isPossible = items.find(element => element.name === item).use;

ids = fieldObjects.filter(element => element.name === fieldObj).map(function(obj) {return obj.id});
alert(ids)

id = map[where].fieldObject.filter(function(n) { return ids.indexOf(n) !== -1;});

if (map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === fieldObj).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length === 1) {

id = map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === fieldObj).map(function(obj) {return obj.id}).indexOf(n) !== -1;});

}

alert(Number(id))
alert(Number(id) > 0)
fo = fieldObjects.find(element => element.id === Number(id));
alert(fo)
alert("Item is in inventory: " + inventory.includes(item) + " Item is useable: " + isPossible + " Useable on this field object: " + "Field object is here: " + (Number(id) > 0))

if (Number(id) > 0 && fo[item] && isPossible === true && inventory.includes(item)) {
alert("HERE")
fo[item]();
} else if (Number(id) > 0 && fo[item] === undefined) {
pf.append("There's no point in doing that.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=use%20" + item + '&type=Not%20A%20Possible%20Usage&where=' + where);
/////////////////////////////////////////////////////////////////
} else if (isPossible === false) {
pf.append("You can't USE that object.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=use%20" + item + '&type=Not%20Usable&where=' + where);
/////////////////////////////////////////////////////////////////
} else if (Number(id) > 0 && inventory.includes(item) === false) {
pf.append("Sorry, you're not carrying this: " + item.toUpperCase())
} else if (Number(id) === 0 && map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === fieldObj).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length > 1) {
ids = map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === fieldObj).map(function(obj) {return obj.id}).indexOf(n) !== -1;})
pf.append("Which " + fieldObj + " do you mean?");
} else if (Number(id) === 0) {
pf.append("Sorry, I can't see this: " + fieldObj.toUpperCase());
}
}
/////////////////////////////////////
function combine(item1,item2) {
if (items.find(element => element.name === item1).hasOwnProperty("combine") && items.find(element => element.name === item1)["combine"][item2]) {
youGet = items.find(element => element.name === item1)["combine"][item2];
pf.append("You now have a " + youGet + ".");
indexItem1 = inventory.indexOf(item1);
inventory.splice(indexItem1,1);
indexItem2 = inventory.indexOf(item2);
inventory.splice(indexItem2,1);
inventory.push(youGet);

} else {
pf.append("It is impossible to combine these.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=combine%20" + item1 + "%20and%20" + item2 + '&type=Not%20A%20Possible%20Interaction&where=' + where);
/////////////////////////////////////////////////////////////////
}
if (items.find(element => element.name === item1)["combine"] === null) {
pf.append("It is impossible to combine this item with anything.");
}
}

///////////////////////////////////////
function drop(object) {
item = items.find(element => element.name === object);
pf.append("You dropped " + item.article + " " + item.name + ".");

index = inventory.indexOf(object);
inventory.splice(index,1);
alert(inventory);
map[where].items.push(object);
}
///////////////////////////////////////
function dropAll() {
map[where].items = map[where].items.concat(inventory);
inventory = [];
pf.append("You dropped everything you were carrying.");
}
//////////////////////////////////////
function interpret(words, SOURCE) {

meaning = words;
j = words.length;


for (i=1; i<words.length+1; i++) {
// alert(words.slice(0,i).join(" "));

if (SOURCE.hasOwnProperty(words.slice(0,i).join(" "))) {
meaning = SOURCE[words.slice(0,i).join(" ")];
j = i;
}

}

words = words.slice(j,words.length);
words.unshift(meaning);
return(words.toString().replace(/,/g," "));

}

//////////////////////////////////////
function interpret2(words, SOURCE) {

meaning = words
j = words.length;


for (i=1; i<words.length; i++) {
// alert(words.slice(0,i).join(" "));

if (SOURCE.hasOwnProperty(words.slice(-i).join(" "))) {
meaning = SOURCE[words.slice(-i).join(" ")];
j = i;
}

}

words = words.slice(0,-j);
words.push(meaning)

return(words.toString().replace(/,/g," "));

}

//////////////////////////////////////
function interact(object,interactionType) {
if (haveToHide === true && interactionType !== "fight") {
result = document.createElement("DIV");
result.innerHTML = "<br>You took your chances with the enemy and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in a dark cell.<br>";
pf.appendChild(result);
inventory = [];
where = 27;
position();

} else {
alert(object + " " + interactionType);

ids = fieldObjects.filter(element => element.name === object).map(function(obj) {return obj.id});
alert(ids)

id = map[where].fieldObject.filter(function(n) { return ids.indexOf(n) !== -1;});

if (map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === object).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length === 1) {
id = map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === object).map(function(obj) {return obj.id}).indexOf(n) !== -1;});
}

alert(id)
alert(Number(id) > 0)

if (Number(id) > 0) {
alert("OK, I see that you want to interact with: " + object + ". And you want to do this type of interaction: " + interactionType);
//alert(Object.keys(fieldObjects.find(element => element.id === id).interact)[0] + ", " + interactionType + " = " + (Object.keys(fieldObjects.find(element => element.id === id).interact)[0] === interactionType));

if (fieldObjects.find(element => element.id === Number(id)).interact.hasOwnProperty(interactionType)) {
fieldObjects.find(element => element.id === Number(id)).interact[interactionType]();
} else {
pf.append(interactionType.toUpperCase() + " is not a possible interaction with " + object.toUpperCase() + ".");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + "&error=" + interactionType + " " + object + '&type=Not%20A%20Possible%20Interaction&where=' + where);
/////////////////////////////////////////////////////////////////
}

} else if (Number(id) === 0 && map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === object).map(function(obj) {return obj.id}).indexOf(n) !== -1;}).length > 1) {
pf.append("Which " + object.toUpperCase() + " do you mean?");
} else {
pf.append(object.toUpperCase() + " is not here.");
}
}
}
///////////////////////////////////////
function loot() {
if (haveToHide === true) {
result = document.createElement("DIV");
result.innerHTML = "<br>You took your chances with the enemy and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in a dark cell.<br>";
pf.appendChild(result);
inventory = [];
where = 27;
position();

} else {
itemsHere = map[where].items;

foType = [];

for (t=0; t<map[where].fieldObject.length; t++) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[t]);
foType.push(fo.type);
}

if (inventory.length+itemsHere.length < 8 && itemsHere.length > 0 && foType.includes("enemy") === false) {

for (i=0; i<itemsHere.length; i++) {
inventory.push(itemsHere[i]);
}
map[where].items = [];
pf.append("You took everything.");
} else if (itemsHere.length === 0) {
pf.append("What do you want to LOOT? There's nothing in here.")
} else if (foType.includes("enemy")) {
pf.append("You can't do that. There's an enemy here.");
} else {
pf.append("You can't LOOT this place, as you're carrying too many things.");
}

}
}
/////////////////////////////////////////
function attempt(code) {
if (haveToHide === true) {
result = document.createElement("DIV");
result.innerHTML = "<br>You took your chances with the enemy and lost. You beg for mercy, get hit in the head with the pommel of his sword, and wake up in a dark cell.<br>";
pf.appendChild(result);
inventory = [];
where = 27;
position();

} else {
alert("oMg");
alert("THIS IS YOUR CODE: " + code);

fo = "";
for (t=0; t<map[where].fieldObject.length; t++) {
if (fieldObjects.find(element => element.id === map[where].fieldObject[t]).try !== undefined) {
fo = fieldObjects.find(element => element.id === map[where].fieldObject[t]);
}
}

if (fo > "") {
alert(fo.try[code]);
fo.try[code]();
} else {
pf.append("Your TRY was in vain.");
}
}
///////////////////////////////////////////
function ask(topic,fieldObj) {
alert(typeof fieldObjects.find(element => element.name === fieldObj))
if (fieldObjects.find(element => element.name === fieldObj) === undefined) {
id = map[where].fieldObject.filter(function(n) { return fieldObjects.filter(element => element.group === fieldObj).map(function(obj) {return obj.id}).indexOf(n) !== -1;});
} else {
id = fieldObjects.find(element => element.name === fieldObj).id;
}
alert(Number(id));

if (map[where].fieldObject.includes(Number(id)) && fieldObjects.find(element => element.id === Number(id)).hasOwnProperty("ask") && fieldObjects.find(element => element.id === Number(id)).ask[topic]) {
fieldObjects.find(element => element.id === Number(id)).ask.topic();
} else if (map[where].fieldObject.includes(Number(id)) === false) {
pf.append(fieldObj.toUpperCase() + " is not here.");
} else if (fieldObjects.find(element => element.id === Number(id)).hasOwnProperty("ask") === false) {
pf.append(fieldObj.toUpperCase() + " is not in the mood to answer your dumb questions.");
} else if (fieldObjects.find(element => element.id === Number(id)).ask[topic] === undefined) {
pf.append(fieldObj.toUpperCase() + ": I know nothing about that, leave me alone.");
pf.append(" I can tell you about the following topics: " + Object.keys(fieldObjects.find(element => element.id === Number(id)).ask).toString().replace(/,/g,", ").toUpperCase());
}

}
}
///////////////////////////////////////////
function shoronAlarm() {
shoronIds = fieldObjects.filter(element => element.name.indexOf("shoron") > -1 && element.name.indexOf("dead") === -1).map(function(element) {return element.id});
alert("These are the living Shorons: " + shoronIds);
for (g=0;g<shoronIds.length;g++) {
for (i=7;i<26;i++) {
if (map[i].fieldObject.includes[shoronIds[g]]) {
map[i].fieldObject.splice(map[i].fieldObject.indexOf(shoronIds[g]),1);
directions = Object.keys(map[i].go);
alert(directions)
alert(typeof Object.keys(map[i].go))
n = Math.floor(Math.random() * directions.length);
alert(n)
alert(directions[n])
map[map[i].go[directions[n]]].fieldObject.push(shoronIds[g]);
alert(directions[n]);

}

}
}

}
///////////////////////////////////////////
function command(e,el) {
if (e.keyCode == 13 && el.value != "" ) {
//&& health>0//
lastCommand = document.createElement("DIV");
lastCommand.innerHTML = "<br>" + el.previousElementSibling.innerHTML + " " + el.value;
pf.appendChild(lastCommand);

el.value = interpret(el.value.toLowerCase().split(" "),dictionary).replace(/the /,"",).trim();

el.value = interpret2(el.value.split(" "),dictionary1);

alert(el.value);
//SYNONYM OF FIELD OBJECT NAME > FIELD OBJECT NAME + GET RID OF 'THE'

commandLine = el.value.toLowerCase().split(" ");

haveToHide = false;
for (i=0;i<map[where].fieldObject.length;i++) {
if (fieldObjects.find(element => element.id === map[where].fieldObject[i]).hide !== undefined) {
haveToHide = true;
}
}

if (commandLine[0] === "go" && Object.keys(map[where].go).includes(commandLine[1])) {
go(commandLine[1]);
} else if (commandLine[0] === "examine" && (items.find(element => element.name === el.value.replace(commandLine[0],"").trim()) || fieldObjects.find(element => element.name === el.value.replace(commandLine[0],"").trim()) || fieldObjects.find(element => element.group === el.value.replace(commandLine[0],"").trim()))) {
examine(el.value.replace(commandLine[0],"").trim());
} else if (["take","get","pick"].includes(commandLine[0]) && map[where].items.includes(commandLine[1])) {
get(commandLine[1]);
} else if (["where", "position"].includes(commandLine[0])) {
position();
} else if (["use"].includes(commandLine[0]) && items.find(element => element.name === el.value.replace(commandLine[0],"").trim()) && commandLine.includes("on") == false) {
use(el.value.replace(commandLine[0],"").trim());
} else if (["use"].includes(commandLine[0]) && items.find(element => element.name === el.value.replace("use ","").slice(0,el.value.replace("use ","").search(" on "))) && commandLine.includes("on")) {
alert(el.value.replace("use ","").slice(0,el.value.replace("use ","").search(" on ")));
alert(el.value.replace("use ","").slice(el.value.replace("use ","").search(" on ")+4));
use2(el.value.replace("use ","").slice(0,el.value.replace("use ","").search(" on ")),el.value.replace("use ","").slice(el.value.replace("use ","").search(" on ")+4));
} else if (["drop"].includes(commandLine[0]) && inventory.includes(el.value.replace(commandLine[0],"").trim())) {
drop(el.value.replace(commandLine[0],"").trim());
} else if (["drop"].includes(commandLine[0]) && commandLine[1] === "all") {
dropAll();
} else if (["combine"].includes(commandLine[0]) && commandLine.includes("and")) {
alert(el.value.replace("combine ","").slice(0,el.value.replace("combine ","").search(" and ")));
alert(el.value.replace("combine ","").slice(el.value.replace("combine ","").search(" and ")+5));

combine(el.value.replace("combine ","").slice(0,el.value.replace("combine ","").search(" and ")),el.value.replace("combine ","").slice(el.value.replace("combine ","").search(" and ")+5));
} else if (commandLine[0] === "instructions") {
pf.appendChild(instructions);
} else if (["inventory", "i", "inv"].includes(commandLine[0])) {
if (inventory.length > 0) {
pf.append("You are carrying ");
list = "";
for (l=0;l<inventory.length-1;l++) {
item = items.find(element => element.name === inventory[l])
list += (item.article + " " + item.name.toUpperCase() + ", ");
}

list = list.slice(0,list.length-2);

if (inventory.length > 1) {
list += " and ";
}

lastItem = items.find(element => element.name === inventory[inventory.length-1]);
list += (lastItem.article + " " + lastItem.name.toUpperCase() + ".");

pf.append(list);
} else {
pf.append("Your inventory is empty.");
}

} else if (commandLine[0] === "hint") {
pf.append(map[where].hint);
} else if (commandLine[0] === "library") {
libri = document.createElement("DIV");
libri.innerHTML = "The library contains these commands:<br>" + Object.keys(library).toString().toUpperCase().replace(/,/g,", ") + "<br>If you want to find out more, type LIBRARY/ + the command's name, and press Enter.";
pf.append(libri);
} else if (el.value.split("/")[0] === "library" && Object.keys(library).includes(el.value.split("/")[1])) {
pf.append(library[el.value.split("/")[1]]);
} else if (["west","north","east","south"].includes(commandLine[1])) {
pf.append("You can't go that way.");
} else if (["back","turn back","go back"].includes(el.value.toString())) {
backTo = getKeyByValue(map[where].go,back[back.length-2]);
if (backTo !== undefined) {
go(backTo);
back.pop();
back.pop();
alert(back);
} else {
pf.append("You are where you were in the beginning.");
}
} else if (commandLine[0] !== "ask" && (fieldObjects.find(element => element.name === el.value.replace(commandLine[0],"").trim()) || fieldObjects.filter(element => element.group === el.value.replace(commandLine[0],"").trim())) && commandLine.length > 1) {
alert("INTERACT");
alert(el.value.replace(commandLine[0],"").trim())
interact(el.value.replace(commandLine[0],"").trim(),commandLine[0]);
} else if (commandLine[0] === "loot") {
loot();
} else if (commandLine[0] === "try" && commandLine.length > 1) {
attempt(commandLine.join(" ").replace("try ",""));
/* } else if (commandLine[0] === "quest") {
alert(quests);
questList = document.createElement("DIV");
questList.style.paddingTop = "5px";
questList.innerHTML = "QUESTS:";
for (z=0; z<quests.length; z++) {
quest = document.createElement("SPAN");
quest.innerHTML = "<br>" + (z+1) + ". "+ quests[z];
questList.appendChild(quest);
}
if (quests.length === 0) {
questList.append(" You have no quests at the moment.");
}
pf.append(questList);

} else if (commandLine[0] === "diagnose") {
healthCondition = document.createElement("P");
if (health > 10) {
healthCondition.innerHTML = "You're relatively good. Of course, you are tired and a little thirsty, but it's fine.";
} else if (health > 5) {
healthCondition.innerHTML = "You look awful. You'd better find someone to heal your wounds.";
}

pf.appendChild(healthCondition);

*/
} else if (commandLine[0] === "ask" && (fieldObjects.find(element => element.name === interpret(el.value.replace("ask ","").slice(0,el.value.replace("ask ","").search(" about ")).split(" "),dictionary1)) || fieldObjects.find(element => element.group === interpret(el.value.replace("ask ","").slice(0,el.value.replace("ask ","").search(" about ")).split(" "),dictionary1)))) {
alert("EZAZ")
alert("TOPIC: " + el.value.replace("ask ","").slice(el.value.replace("ask ","").search(" about ")+7) + " FIELD OBJECT: " + interpret(el.value.replace("ask ","").slice(0,el.value.replace("ask ","").search(" about ")).split(" "),dictionary1));
ask(el.value.replace("ask ","").slice(el.value.replace("ask ","").search(" about ")+7),interpret(el.value.replace("ask ","").slice(0,el.value.replace("ask ","").search(" about ")).split(" "),dictionary1));
} else if (el.value === "hide") {

typeOfFieldObjects = [];
for (i=0;i<map[where].fieldObject.length;i++) {
typeOfFieldObjects.push(fieldObjects.find(element => element.id === map[where].fieldObject[i]).type);
}

if (typeOfFieldObjects.includes["enemy"] === false || typeOfFieldObjects.length === 0) {
pf.append("There's nothing to hide from around here.")
} else {

for (i=0;i<map[where].fieldObject.length;i++) {
if (fieldObjects.find(element => element.id === map[where].fieldObject[i]).hide !== undefined) {
fieldObjects.find(element => element.id === map[where].fieldObject[i]).hide(); } else if (fieldObjects.find(element => element.id === map[where].fieldObject[i]).type === "enemy") {
pf.append("Nothing happens.");
}
}
}


} else {
pf.append("Sorry, I don't understand.");
/////////////////////////////////////////////////////////////////
xhr.open('POST', errorData, true);
xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
xhr.send('name=' + betaTesterName + '&date=' + new Date().toLocaleDateString() + "%20" + new Date().toLocaleTimeString() + '&error=' + el.value + '&type=Not%20Found%20In%20Dictionary&where=' + where);
/////////////////////////////////////////////////////////////////
}

el.value = "";

/*} else if (health === 0 && e.keyCode == 13 && el.value !== "restart") {
pf.innerHTML = "You got yourself killed, you can't do anything. PRESS 'R' TO RESTART THE GAME";
el.value = "";
} else if (health === 0 && e.keyCode == 13 && el.value === "restart") {
window.location.reload();
*/
}
pf.lastElementChild.scrollIntoView(true);
}

function enterName(e,el) {
if (e.keyCode == 13) {
if (el.value !== "") {
betaTesterName = el.value;
}
alert("Welcome " + betaTesterName + "! You're about to beta test this interactive fiction game (engine). Thanks for your time and support.");
el.previousElementSibling.previousElementSibling.style.display = "none";
el.previousElementSibling.style.display = "none";
el.style.display = "none";
}
}

</script>
